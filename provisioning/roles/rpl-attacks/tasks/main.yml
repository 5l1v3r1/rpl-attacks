---
# Install required packages
- include: requirements.yml

# Install RPLAF
- block:

  - name: Clone repository
    git:
      repo: "https://github.com/dhondta/rpl-attacks.git"
      dest: "{{ rplaf_root }}"
      force: yes
      recursive: no
      accept_hostkey: yes

  - name: Clean deployment artifacts
    file:
      path: "{{ rplaf_root }}/{{ item }}"
      state: absent
    with_items:
      - provisioning
      - Vagrantfile

  - name: Install Python requirements
    pip:
      requirements: "{{ rplaf_root }}/requirements.txt"
    sudo: yes

  - name: Change main Python script's mode to executable
    file:
      dest: "{{ rplaf_root }}/main.py"
      mode: 0744

  - name: Copy configuration file
    template:
      src: .rpl-attacks.conf
      dest: "~/"

  - name: Test RPL Attacks Framework
    command: fab test
    args:
      chdir: "{{ rplaf_root }}"

  become: yes
  become_user: vagrant
